"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[366],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=l(n),h=o,u=m["".concat(p,".").concat(h)]||m[h]||c[h]||r;return n?a.createElement(u,i(i({ref:t},d),{},{components:n})):a.createElement(u,i({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[m]="string"==typeof e?e:o,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2403:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var a=n(7462),o=(n(7294),n(3905));const r={title:"Volumes in action"},i=void 0,s={unversionedId:"part-2/section-3",id:"part-2/section-3",title:"Volumes in action",description:"Next we're going to set up the project management application Redmine, a PostgreSQL database and Adminer, a graphical interface for database administration.",source:"@site/docs/part-2/section-3.md",sourceDirName:"part-2",slug:"/part-2/section-3",permalink:"/part-2/section-3",draft:!1,editUrl:"https://github.com/docker-hy/docker-hy.github.io/blob/master/docs/part-2/section-3.md",tags:[],version:"current",frontMatter:{title:"Volumes in action"},sidebar:"materialSidebar",previous:{title:"Docker networking",permalink:"/part-2/section-2"},next:{title:"Containers in development",permalink:"/part-2/section-4"}},p={},l=[{value:"Exercises 2.6 - 2.10",id:"exercises-26---210",level:2}],d={toc:l},m="wrapper";function c(e){let{components:t,...r}=e;return(0,o.kt)(m,(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Next we're going to set up the project management application ",(0,o.kt)("a",{parentName:"p",href:"https://www.redmine.org/"},"Redmine"),", a PostgreSQL database and ",(0,o.kt)("a",{parentName:"p",href:"https://www.adminer.org/"},"Adminer"),", a graphical interface for database administration."),(0,o.kt)("p",null,"All of the above have official Docker images available as we can see from ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/redmine"},"Redmine"),", ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/postgres"},"Postgres")," and ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/adminer"},"Adminer")," respectively. The officiality of the containers is not that important, just that we can expect that it will have some support. We could also, for example, setup Wordpress or a MediaWiki inside containers in the same manner if you're interested in running existing applications inside Docker. You could even set up an application monitoring tool such as ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/sentry/"},"Sentry"),"."),(0,o.kt)("p",null,"In ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/redmine"},"https://hub.docker.com/_/redmine")," there is a list of different tagged versions:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Redmine",src:n(9594).Z,width:"1558",height:"464"})),(0,o.kt)("p",null,"We can most likely use any of the available images."),(0,o.kt)("p",null,"From the section ",(0,o.kt)("em",{parentName:"p"},"Environment Variables")," we can see that all versions can use ",(0,o.kt)("inlineCode",{parentName:"p"},"REDMINE_DB_POSTGRES")," environment variable to set up a Postgres database. So before moving forward, let's setup Postgres for us."),(0,o.kt)("p",null,"In ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/postgres"},"https://hub.docker.com/_/postgres")," there's a sample compose file under the section \"via docker-compose or docker stack deploy\". Let's strip that down as follows"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.8"\n\nservices:\n  db:\n    image: postgres:13.2-alpine\n    restart: unless-stopped\n    environment:\n      POSTGRES_PASSWORD: example\n    container_name: db_redmine\n')),(0,o.kt)("p",null,"Note:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"restart: always")," was changed to ",(0,o.kt)("inlineCode",{parentName:"li"},"unless-stopped"),", that will keep the container running unless we explicitly stop it. With ",(0,o.kt)("inlineCode",{parentName:"li"},"always")," the stopped container is started after reboot, for example, see ",(0,o.kt)("a",{parentName:"li",href:"https://docs.docker.com/config/containers/start-containers-automatically/"},"here")," for more.")),(0,o.kt)("p",null,"Under the section ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-library/docs/blob/master/postgres/README.md#where-to-store-data"},"Where to store data"),", we can see that the ",(0,o.kt)("inlineCode",{parentName:"p"},"/var/lib/postgresql/data")," should be mounted separately to preserve the data."),(0,o.kt)("p",null,"There are two options for doing the mounting. We could use a bind mount like previously and mount an easy-to-locate directory for storing the data. Let us now use the other option, a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/storage/volumes/"},"Docker managed volume"),"."),(0,o.kt)("p",null,"Let's run the Docker Compose file without setting anything new:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},'$ docker compose up\n\n  \u2714 Network redmine_default  Created                                                                                              0.0s\n  \u2714 Container db_redmine     Created                                                                                              0.2s\n  Attaching to db_redmine\n  db_redmine  | The files belonging to this database system will be owned by user "postgres".\n  db_redmine  | This user must also own the server process.\n  ...\n  db_redmine  | 2024-03-11 14:05:52.340 UTC [1] LOG:  starting PostgreSQL 13.2 on aarch64-unknown-linux-musl, compiled by gcc (Alpine 10.2.1_pre1) 10.2.1 20201203, 64-bit\n  db_redmine  | 2024-03-11 14:05:52.340 UTC [1] LOG:  listening on IPv4 address "0.0.0.0", port 5432\n  db_redmine  | 2024-03-11 14:05:52.340 UTC [1] LOG:  listening on IPv6 address "::", port 5432\n  db_redmine  | 2024-03-11 14:05:52.342 UTC [1] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"\n  db_redmine  | 2024-03-11 14:05:52.345 UTC [46] LOG:  database system was shut down at 2024-03-11 14:05:52 UTC\n  db_redmine  | 2024-03-11 14:05:52.347 UTC [1] LOG:  database system is ready to accept connections\n')),(0,o.kt)("p",null,"The image initializes the data files in the first start. Let's terminate the container with ^C. Compose uses the current directory as a prefix for container and volume names so that different projects don't clash (The prefix can be overridden with ",(0,o.kt)("inlineCode",{parentName:"p"},"COMPOSE_PROJECT_NAME")," environment variable if needed)."),(0,o.kt)("p",null,"Let's ",(0,o.kt)("strong",{parentName:"p"},"inspect")," if there was a volume created with ",(0,o.kt)("inlineCode",{parentName:"p"},"docker container inspect db_redmine | grep -A 5 Mounts")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'"Mounts": [\n    {\n        "Type": "volume",\n        "Name": "2d86a2480b60743147ce88e8e70b612d10b4c4151779b462baf4e81b84061ef5",\n        "Source": "/var/lib/docker/volumes/2d86a2480b60743147ce88e8e70b612d10b4c4151779b462baf4e81b84061ef5/_data",\n        "Destination": "/var/lib/postgresql/data",\n')),(0,o.kt)("p",null,"An indeed there is one! So despite us ",(0,o.kt)("strong",{parentName:"p"},"not")," configuring one explicitly, an anonymous volume was automatically created for us."),(0,o.kt)("p",null,"Now if we check out ",(0,o.kt)("inlineCode",{parentName:"p"},"docker volume ls"),' we can see that a volume with the name "2d86a2480b60743147ce88e8e70b612d10b4c4151779b462baf4e81b84061ef5" exists.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"$ docker volume ls\n  DRIVER              VOLUME NAME\n  local     2d86a2480b60743147ce88e8e70b612d10b4c4151779b462baf4e81b84061ef5\n")),(0,o.kt)("p",null,"There may be more volumes on your machine. If you want to get rid of them you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"docker volume prune"),'. Let\'s put the whole "application" down now with ',(0,o.kt)("inlineCode",{parentName:"p"},"docker compose down"),"."),(0,o.kt)("p",null,"Instead of the randomly named volume we better define one explicitly.\nLet us change the definition as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.8"\n\nservices:\n  db:\n    image: postgres:13.2-alpine\n    restart: unless-stopped\n    environment:\n      POSTGRES_PASSWORD: example\n    container_name: db_redmine\n    volumes:\n      - database:/var/lib/postgresql/data\n\nvolumes:\n  database:\n')),(0,o.kt)("p",null,"Now, after running ",(0,o.kt)("inlineCode",{parentName:"p"},"docker compose up")," again, let us check what it looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},'$ docker volume ls\n  DRIVER              VOLUME NAME\n  local               redmine_database\n\n$ docker container inspect db_redmine | grep -A 5 Mounts\n"Mounts": [\n    {\n        "Type": "volume",\n        "Name": "redmine_database",\n        "Source": "/var/lib/docker/volumes/ongoing_redminedata/_data",\n        "Destination": "/var/lib/postgresql/data",\n')),(0,o.kt)("p",null,"Ok, looks a bit more human-readable! Now when the Postgres is running, it is time to add ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/redmine"},"Redmine"),"."),(0,o.kt)("p",null,"The container seems to require just two environment variables."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"redmine:\n  image: redmine:5.1-alpine\n  environment:\n    - REDMINE_DB_POSTGRES=db\n    - REDMINE_DB_PASSWORD=example\n  ports:\n    - 9999:3000\n  depends_on:\n    - db\n")),(0,o.kt)("p",null,"Notice the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/compose-file/compose-file-v3/#depends_on"},"depends_on")," declaration. This makes sure that the ",(0,o.kt)("inlineCode",{parentName:"p"},"db")," service is started first. ",(0,o.kt)("inlineCode",{parentName:"p"},"depends_on"),' does not guarantee that the database is up, just that it is started first. The Postgres server is accessible with the DNS name "db" from the Redmine service as discussed in the section ',(0,o.kt)("a",{parentName:"p",href:"/part-2/section-2"},"Docker networking"),"."),(0,o.kt)("p",null,"Now when you run ",(0,o.kt)("inlineCode",{parentName:"p"},"docker compose up")," you will see a bunch of database migrations running first."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"  redmine_1  | I, [2024-03-03T10:59:20.956936 #25]  INFO -- : Migrating to Setup (1)\n  redmine_1  | == 1 Setup: migrating =========================================================\n  ...\n  redmine_1  | [2024-03-03 11:01:10] INFO  ruby 3.2.3 (2024-01-30) [x86_64-linux]\n  redmine_1  | [2024-03-03 11:01:10] INFO  WEBrick::HTTPServer#start: pid=1 port=3000\n")),(0,o.kt)("p",null,"As the ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/redmine"},"documentation")," mentions, the image creates files to ",(0,o.kt)("inlineCode",{parentName:"p"},"/usr/src/redmine/files")," and those are better to be persisted. The Dockerfile has this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-library/redmine/blob/cea16044e97567c28802fc8cc06f6cd036c49a5c/4.0/Dockerfile#L155"},"line")," where it declares that a volume should be created. Again Docker will create the volume, but it will be handled as an anonymous volume that is not managed by the Docker Compose, so it's better to create it explicitly."),(0,o.kt)("p",null,"With that in mind, our configuration changes to this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.8"\n\nservices:\n  db:\n    image: postgres:13.2-alpine\n    restart: unless-stopped\n    environment:\n      POSTGRES_PASSWORD: example\n    container_name: db_redmine\n    volumes:\n      - database:/var/lib/postgresql/data\n  redmine:\n    image: redmine:4.1-alpine\n    environment:\n      - REDMINE_DB_POSTGRES=db\n      - REDMINE_DB_PASSWORD=example\n    ports:\n      - 9999:3000\n    volumes:\n      - files:/usr/src/redmine/files\n    depends_on:\n      - db\n\nvolumes:\n  database:\n  files:\n')),(0,o.kt)("p",null,"Now we can use the application with our browser through ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:9999"},"http://localhost:9999"),". After some changes inside the application, we can inspect the changes that happened in the image and check that no extra meaningful files got written to the container:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"$ docker container diff $(docker compose ps -q redmine)\n  C /usr/src/redmine/config/environment.rb\n  ...\n  C /usr/src/redmine/tmp/pdf\n")),(0,o.kt)("p",null,"Probably not."),(0,o.kt)("p",null,"We could use command ",(0,o.kt)("inlineCode",{parentName:"p"},"psql")," inside the Postgres container to interact with the database by running"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"docker container exec -it db_redmine psql -U postgres\n")),(0,o.kt)("p",null,"The same method can be used to create backups with pg_dump"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"docker container exec db_redmine pg_dump -U postgres > redmine.dump\n")),(0,o.kt)("p",null,"Rather than using the archaic command line interface to access Postgres, let us now set up the database ",(0,o.kt)("a",{parentName:"p",href:"https://www.adminer.org/"},"Adminer")," to the application."),(0,o.kt)("p",null,"After a look at the ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/adminer"},"documentation"),", the setup is straightforward:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"adminer:\n  image: adminer:4\n  restart: always\n  environment:\n    - ADMINER_DESIGN=galkaev\n  ports:\n    - 8083:8080\n")),(0,o.kt)("p",null,"Now when we run the application we can access the adminer from ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:8083"},"http://localhost:8083"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Adminer view",src:n(6715).Z,width:"1892",height:"730"})),(0,o.kt)("p",null,"Setting up the adminer is straightforward since it will be able to access the database through the Docker network. You may wonder how the adminer finds the Postgres database container. We provide this information to Redmine using an environment variable:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  redmine:\n    environment:\n      - REDMINE_DB_POSTGRES=db\n")),(0,o.kt)("p",null,"Adminer actually assumes that the database has DNS name  ",(0,o.kt)("em",{parentName:"p"},"db")," so with this name selection, we did not have to specify anything. If the database has some other name, we have to pass it to adminer using an environment variable:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  adminer:\n    environment:\n      - ADMINER_DEFAULT_SERVER=database_server\n")),(0,o.kt)("h2",{id:"exercises-26---210"},"Exercises 2.6 - 2.10"),(0,o.kt)("admonition",{title:"Exercise 2.6",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Let us continue with the example app that we worked with in ",(0,o.kt)("a",{parentName:"p",href:"/part-2/section-2#exercise-24"},"Exercise 2.4"),"."),(0,o.kt)("p",{parentName:"admonition"},"Now you should add a database to the example backend."),(0,o.kt)("p",{parentName:"admonition"},"Use a Postgres database to save messages. For now, there is no need to configure a volume since the official Postgres image sets a default volume for us. Use the Postgres image documentation to your advantage when configuring: ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/postgres/"},"https://hub.docker.com/","_","/postgres/"),". Especially part ",(0,o.kt)("em",{parentName:"p"},"Environment Variables")," is a valuable one."),(0,o.kt)("p",{parentName:"admonition"},"The backend ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/material-applications/tree/main/example-backend"},"README")," should have all the information needed to\nconnect."),(0,o.kt)("p",{parentName:"admonition"},"There is again a button (and a form!) in the frontend that you can use to ensure your configuration is done right."),(0,o.kt)("p",{parentName:"admonition"},"Submit the docker-compose.yml"),(0,o.kt)("p",{parentName:"admonition"},"TIPS:"),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"When configuring the database, you might need to destroy the automatically created volumes. Use commands ",(0,o.kt)("inlineCode",{parentName:"li"},"docker volume prune"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"docker volume ls")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"docker volume rm")," to remove unused volumes when testing. Make sure to remove containers that depend on them beforehand."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"restart: unless-stopped")," can help if the Postgres takes a while to get ready")),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("img",{alt:"Backend, frontend, redis and a database",src:n(7389).Z,width:"713",height:"291"}))),(0,o.kt)("admonition",{title:"Exercise 2.7",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Postgres image uses a volume by default. Define manually a volume for the database in a convenient location such as in ",(0,o.kt)("inlineCode",{parentName:"p"},"./database")," so you should use now a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/storage/bind-mounts/"},"bind mount"),". The image ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-library/docs/blob/master/postgres/README.md#where-to-store-data"},"documentation")," may help you with the task."),(0,o.kt)("p",{parentName:"admonition"},"After you have configured the bind mount volume:"),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"Save a few messages through the frontend"),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose down")),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose up")," and see that the messages are available after refreshing browser"),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose down")," and delete the volume folder manually"),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose up")," and the data should be gone")),(0,o.kt)("blockquote",{parentName:"admonition"},(0,o.kt)("p",{parentName:"blockquote"},"TIP: To save you the trouble of testing all of those steps, just look into the folder before trying the steps. If\nit's empty after ",(0,o.kt)("inlineCode",{parentName:"p"},"docker compose up")," then something is wrong.")),(0,o.kt)("p",{parentName:"admonition"},"Submit the docker-compose.yml"),(0,o.kt)("p",{parentName:"admonition"},"The benefit of a bind mount is that since you know exactly where the data is in your file system, it is easy to create backups. If the Docker managed volumes are used, the location of the data in the file system can not be controlled and that makes backups a bit less trivial...")),(0,o.kt)("admonition",{title:"Tips for making sure the backend connection works",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"In the next exercise try using your browser to access http://localhost/api/ping and see if it answers pong"),(0,o.kt)("p",{parentName:"admonition"},"It might be Nginx configuration problem. Ensure there is a trailing / on the backend URL as specified under the location /api/ context in the nginx.conf.")),(0,o.kt)("admonition",{title:"Exercise 2.8",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"In this exercise, you shall add ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/nginx"},"Nginx")," to work as a ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Reverse_proxy"},"reverse proxy")," in front of the example app frontend and backend."),(0,o.kt)("p",{parentName:"admonition"},"According to Wikipedia ",(0,o.kt)("em",{parentName:"p"},"a reverse proxy is a type of proxy server that retrieves resources on behalf of a client from one or more servers. These resources are then returned to the client, appearing as if they originated from the reverse proxy server itself.")),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("img",{alt:"Backend, frontend, redis, a database and nginx",src:n(9462).Z,width:"646",height:"331"})),(0,o.kt)("p",{parentName:"admonition"},"So in our case, the reverse proxy will be the single point of entry to our application, and the final goal will be to set both the React frontend and the Express backend behind the reverse proxy."),(0,o.kt)("p",{parentName:"admonition"},"The idea is that a browser makes ",(0,o.kt)("em",{parentName:"p"},"all")," requests to ",(0,o.kt)("em",{parentName:"p"},"http://localhost"),". If the request has a URL prefix ",(0,o.kt)("em",{parentName:"p"},"http://localhost/api"),", Nginx should forward the request to the backend container. All the other requests are directed to the frontend container."),(0,o.kt)("p",{parentName:"admonition"},"So, at the end, you should see that the frontend is accessible simply by going to ",(0,o.kt)("a",{parentName:"p",href:"http://localhost"},"http://localhost"),". All buttons, except the one labeled ",(0,o.kt)("em",{parentName:"p"},"Exercise 2.8")," may have stopped working, do not worry about them, we shall fix that later."),(0,o.kt)("p",{parentName:"admonition"},"The following file should be set to ",(0,o.kt)("em",{parentName:"p"},"/etc/nginx/nginx.conf")," inside the Nginx container. You can use a file bind mount where the contents of the file is the following:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"events { worker_connections 1024; }\n\nhttp {\n  server {\n    listen 80;\n\n    location / {\n      proxy_pass _frontend-connection-url_;\n    }\n\n    # configure here where requests to http://localhost/api/...\n    # are forwarded\n    location /api/ {\n      proxy_set_header Host $host;\n      proxy_pass _backend-connection-url_;\n    }\n  }\n}\n")),(0,o.kt)("p",{parentName:"admonition"},"Nginx, backend and frontend should be connected in the same network. See the image above for how the services are connected. You find ",(0,o.kt)("a",{parentName:"p",href:"https://www.nginx.com/resources/wiki/start/topics/examples/full/"},"Nginx-documentation")," helpful, but remember, the configuration you need is pretty straightforward, if you end up doing complex things, you are most likely doing something wrong."),(0,o.kt)("p",{parentName:"admonition"},'If and when your app "does not work", remember to have a look in the log, it can be pretty helpful in pinpointing errors:'),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"2_7-proxy-1  | /docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh\n2_7-proxy-1  | /docker-entrypoint.sh: Configuration complete; ready for start up\n2_7-proxy-1  | 2023/03/05 09:24:51 [emerg] 1#1: invalid URL prefix in /etc/nginx/nginx.conf:8\n2_7-proxy-1 exited with code 1\n")),(0,o.kt)("p",{parentName:"admonition"},"Submit the docker-compose.yml")),(0,o.kt)("admonition",{title:"Exercise 2.9",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Most of the buttons may have stopped working in the example application. Make sure that every button for exercises works."),(0,o.kt)("p",{parentName:"admonition"},"Remember to take a peek into the browser's developer consoles again like we did back ",(0,o.kt)("a",{parentName:"p",href:"/part-1/section-6"},"part 1"),", remember also ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/material-applications/tree/main/example-frontend#exercise-114---to-connect-to-backend"},"this")," and ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker-hy/material-applications/tree/main/example-backend"},"this"),"."),(0,o.kt)("p",{parentName:"admonition"},"The buttons of the Nginx exercise and the first button behave differently but you want them to match."),(0,o.kt)("p",{parentName:"admonition"},"If you had to make any changes explain what you did and where."),(0,o.kt)("p",{parentName:"admonition"},"Submit the docker-compose.yml and both Dockerfiles.")),(0,o.kt)("admonition",{title:"Publishing ports to host network",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"There is an important lesson about Docker networking and ports to be learned in the next exercise."),(0,o.kt)("p",{parentName:"admonition"},"When we do a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/desktop/networking/#port-mapping"},"port mapping"),", in ",(0,o.kt)("inlineCode",{parentName:"p"},"docker run -p 8001:80 ...")," or in the Docker Compose file, we ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/config/containers/container-networking/#published-ports"},"publish")," a container port to the host network to be accessible in localhost."),(0,o.kt)("p",{parentName:"admonition"},"The container port is there within the Docker network accessible by the other containers that are in the same network even if we do not publish anything. So publishing the ports is only for exposing ports outside the Docker network. If no direct access outside the network is not needed, then we just do not publish anything.")),(0,o.kt)("admonition",{title:"Exercise 2.10",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Now we have the reverse proxy up and running! All the communication to our app should be done through the reverse proxy and direct access (eg. accessing the backend with a GET to http://localhost:8080/ping ) should be prevented."),(0,o.kt)("p",{parentName:"admonition"},"Use a port scanner, eg ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/networkstatic/nmap"},"https://hub.docker.com/r/networkstatic/nmap")," to ensure that there are no extra ports open in the host."),(0,o.kt)("p",{parentName:"admonition"},"It might be enough to just run"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre"},"$ docker run -it --rm --network host networkstatic/nmap localhost\n")),(0,o.kt)("p",{parentName:"admonition"},"If you have an M1/M2 Mac, you might need to build the image yourself."),(0,o.kt)("p",{parentName:"admonition"},"The result looks like the following (I used a self-built image):"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker run -it --rm --network host nmap localhost\nStarting Nmap 7.93 ( https://nmap.org ) at 2023-03-05 12:28 UTC\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.0000040s latency).\nOther addresses for localhost (not scanned): ::1\nNot shown: 996 closed tcp ports (reset)\nPORT     STATE    SERVICE\n80/tcp   filtered http\n111/tcp  open     rpcbind\n5000/tcp filtered commplex-link\n8080/tcp filtered http-proxy\n\nNmap done: 1 IP address (1 host up) scanned in 1.28 seconds\n")),(0,o.kt)("p",{parentName:"admonition"},"As we see, there are two suspicious open ports: 5000 and 8080. So it is obvious that the frontend and backend are still directly accessible in the host network. This should be fixed!"),(0,o.kt)("p",{parentName:"admonition"},"You are done when the port scan report looks something like this:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-05 12:39 UTC\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.0000040s latency).\nOther addresses for localhost (not scanned): ::1\nNot shown: 998 closed tcp ports (reset)\nPORT    STATE    SERVICE\n80/tcp  filtered http\n111/tcp open     rpcbind\n\nNmap done: 1 IP address (1 host up) scanned in 1.28 seconds\n"))))}c.isMDXComponent=!0},6715:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/adminer-fea0b2f85933608d9bba6981eeb033c7.png"},9594:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/redmine2024-c58915fec1682f9c84e2ba48332a3f85.png"},7389:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/back-front-redis-and-database-5aaf7f70f4e7f9f0873e2be9710ea5e6.png"},9462:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/back-front-redis-database-and-nginx-6cf5c082483c2a445501cafe19017fbc.png"}}]);